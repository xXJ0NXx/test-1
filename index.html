<!DOCTYPE html>
<html lang="en">
<head>
  <title>PixelCraft + Eaglercraft Hybrid</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A hybrid of PixelCraft and Eaglercraft. Play Minecraft 1.5.2 in your browser with multiplayer and RSA encryption." />
  <meta name="author" content="lax1dude + ayunami" />
  
  <!-- PixelCraft core libraries -->
  <script src="jsbn/jsbn.js"></script>
  <script src="jsbn/jsbn2.js"></script>
  <script src="jsbn/base64.js"></script>
  <script src="jsbn/prng4.js"></script>
  <script src="jsbn/rng.js"></script>
  <script src="jsbn/rsa.js"></script>
  <script src="jsbn/rsa2.js"></script>
  <script src="asn1-parser.js"></script>
  <script src="music.js"></script>
  
  <!-- Optional Eaglercraft networking -->
  <script src="eagswebrtc.js"></script>
</head>
<body style="margin:0;width:100vw;height:100vh;" id="game_frame"></body>
<script>
var name="PixelCraft", motd="A public 1.5.2 server", ip="pixelcraft.me";

// Load scripts dynamically - both files are required
function loadScript(src, required = true) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => {
      console.log(`✓ Successfully loaded: ${src}`);
      resolve(src);
    };
    script.onerror = () => {
      if (required) {
        reject(new Error(`Failed to load required file: ${src}`));
      } else {
        console.warn(`Optional script not loaded: ${src}`);
        resolve(null);
      }
    };
    document.head.appendChild(script);
  });
}

// Load scripts dynamically - both files are required
function loadScript(src, required = true) {
  return new Promise((resolve, reject) => {
    console.log(`Attempting to load: ${src}`);
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => {
      console.log(`✓ Successfully loaded: ${src}`);
      resolve(src);
    };
    script.onerror = (e) => {
      console.error(`✗ Failed to load: ${src}`, e);
      if (required) {
        reject(new Error(`Failed to load required file: ${src}`));
      } else {
        console.warn(`Optional script not loaded: ${src}`);
        resolve(null);
      }
    };
    document.head.appendChild(script);
  });
}

// Load unmodded.js first, then modded.js sequentially to combine them
console.log('Starting game file loading sequence...');

// Show loading indicator
document.getElementById('game_frame').innerHTML = '<div id="loading-status" style="color:white;padding:20px;font-family:monospace;background:#000;">Loading game files...</div>';

loadScript('unmodded.js', true).then(() => {
  console.log('✓ Base classes loaded from unmodded.js');
  document.getElementById('loading-status').innerHTML += '<br>✓ unmodded.js loaded (vanilla base)';
  console.log('Now loading modded.js...');
  
  // Now load modded.js - it will merge with/override unmodded classes
  return loadScript('modded.js', true);
}).then(() => {
  console.log('✓ Modifications loaded from modded.js');
  document.getElementById('loading-status').innerHTML += '<br>✓ modded.js loaded (modifications)';
  console.log('✓✓ Combined mode active: unmodded.js + modded.js');
  console.log('Initializing game...');
  
  // Show final status before starting game
  document.getElementById('loading-status').innerHTML += '<br><br>✓✓ Both files combined successfully!<br>Starting game...';
  
  setTimeout(() => {
    // Both files loaded and combined, initialize game
    initGame();
  }, 1000); // Brief delay so you can see the message
}).catch((error) => {
  console.error('❌ FATAL ERROR during file loading:', error);
  document.getElementById('game_frame').innerHTML = 
    '<div style="color:red;padding:20px;font-family:sans-serif;"><strong>Error: Game files failed to load</strong><br><br>' + error.message + '<br><br>Please ensure both unmodded.js and modded.js are present in the same directory as this HTML file.<br><br>Check the browser console (F12) for more details.</div>';
});').innerHTML = 
    '<div style="color:red;padding:20px;font-family:sans-serif;"><strong>Error: Game files failed to load</strong><br><br>' + error.message + '<br><br>Please ensure both unmodded.js and modded.js are present in the same directory as this HTML file.</div>';
});

function initGame() {
  document.requestPointerLock = document.requestPointerLock || function(){};
  document.exitPointerLock = document.exitPointerLock || function(){};
  
  // Combine PixelCraft startup with Eaglercraft relays
  const relayId = Math.floor(Math.random() * 3);
  window.eaglerRelays = [
    { addr: "wss://relay.deev.is/", name: "relay #1", primary: relayId == 0 },
    { addr: "wss://relay.lax1dude.net/", name: "relay #2", primary: relayId == 1 },
    { addr: "wss://relay.shhnowisnottheti.me/", name: "relay #3", primary: relayId == 2 }
  ];
  
  // PixelCraft startup configuration
  window.minecraftOpts = [
    "game_frame","assets.epk",
    btoa(atob("CgAACQAHc2VydmVycwoAAAABCAAKZm9yY2VkTU9URABtb3RkaGVyZQEAC2hpZGVBZGRyZXNzAQgAAmlwAGlwaGVyZQgABG5hbWUAbmFtZWhlcmUAAA==")
      .replace("motdhere", String.fromCharCode(motd.length)+motd)
      .replace("namehere", String.fromCharCode(name.length)+name)
      .replace("iphere", String.fromCharCode(ip.length)+ip))
  ];
  
  // Support URL ?server= query parameter
  var q = new URLSearchParams(window.location.search);
  if(q.has("server")) window.minecraftOpts.push(q.get("server"));
  
  // Initialize the game
  if (typeof main === 'function') {
    main();
  } else {
    console.error('main() function not found - check if game files loaded correctly');
    document.getElementById('game_frame').innerHTML = 
      '<div style="color:red;padding:20px;font-family:sans-serif;">Error: main() function not found. Game files may be corrupted.</div>';
  }
}
</script>
</html>
