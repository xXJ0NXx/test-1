<!DOCTYPE html>
<html lang="en">
<head>
  <title>PixelCraft + Eaglercraft Hybrid</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="A hybrid of PixelCraft and Eaglercraft. Play Minecraft 1.5.2 in your browser with multiplayer and RSA encryption." />
  <meta name="author" content="lax1dude + ayunami" />
  
  <!-- PixelCraft core libraries -->
  <script src="jsbn/jsbn.js"></script>
  <script src="jsbn/jsbn2.js"></script>
  <script src="jsbn/base64.js"></script>
  <script src="jsbn/prng4.js"></script>
  <script src="jsbn/rng.js"></script>
  <script src="jsbn/rsa.js"></script>
  <script src="jsbn/rsa2.js"></script>
  <script src="asn1-parser.js"></script>
  <script src="music.js"></script>
  
  <!-- Optional Eaglercraft networking -->
  <script src="eagswebrtc.js"></script>
</head>
<body style="margin:0;width:100vw;height:100vh;" id="game_frame"></body>
<script>
var name="PixelCraft", motd="A public 1.5.2 server", ip="pixelcraft.me";

// Load scripts dynamically with fallback support
function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = () => resolve(src);
    script.onerror = () => {
      console.warn(`Optional script not loaded: ${src}`);
      resolve(null); // Resolve anyway, don't reject
    };
    document.head.appendChild(script);
  });
}

// Load unmodded.js first, then modded.js sequentially to combine them
loadScript('unmodded.js').then((unmoddedResult) => {
  if (!unmoddedResult) {
    throw new Error('unmodded.js failed to load - this file is required');
  }
  console.log('✓ unmodded.js loaded (vanilla base)');
  
  // Now load modded.js - it will merge with/override unmodded classes
  return loadScript('modded.js');
}).then((moddedResult) => {
  if (!moddedResult) {
    throw new Error('modded.js failed to load - this file is required');
  }
  console.log('✓ modded.js loaded (merged with base)');
  console.log('✓ Combined mode active: unmodded.js + modded.js');
  
  // Both files loaded and combined, initialize game
  initGame();
}).catch((error) => {
  console.error('Failed to load game files:', error);
  document.getElementById('game_frame').innerHTML = 
    '<div style="color:red;padding:20px;font-family:sans-serif;"><strong>Error: Game files failed to load</strong><br><br>' + error.message + '<br><br>Please ensure both unmodded.js and modded.js are present.</div>';
});

function initGame() {
  document.requestPointerLock = document.requestPointerLock || function(){};
  document.exitPointerLock = document.exitPointerLock || function(){};
  
  // Combine PixelCraft startup with Eaglercraft relays
  const relayId = Math.floor(Math.random() * 3);
  window.eaglerRelays = [
    { addr: "wss://relay.deev.is/", name: "relay #1", primary: relayId == 0 },
    { addr: "wss://relay.lax1dude.net/", name: "relay #2", primary: relayId == 1 },
    { addr: "wss://relay.shhnowisnottheti.me/", name: "relay #3", primary: relayId == 2 }
  ];
  
  // PixelCraft startup configuration
  window.minecraftOpts = [
    "game_frame","assets.epk",
    btoa(atob("CgAACQAHc2VydmVycwoAAAABCAAKZm9yY2VkTU9URABtb3RkaGVyZQEAC2hpZGVBZGRyZXNzAQgAAmlwAGlwaGVyZQgABG5hbWUAbmFtZWhlcmUAAA==")
      .replace("motdhere", String.fromCharCode(motd.length)+motd)
      .replace("namehere", String.fromCharCode(name.length)+name)
      .replace("iphere", String.fromCharCode(ip.length)+ip))
  ];
  
  // Support URL ?server= query parameter
  var q = new URLSearchParams(window.location.search);
  if(q.has("server")) window.minecraftOpts.push(q.get("server"));
  
  // Initialize the game
  if (typeof main === 'function') {
    main();
  } else {
    console.error('main() function not found - check if game files loaded correctly');
    document.getElementById('game_frame').innerHTML = 
      '<div style="color:red;padding:20px;font-family:sans-serif;">Error: main() function not found. Game files may be corrupted.</div>';
  }
}
</script>
</html>
